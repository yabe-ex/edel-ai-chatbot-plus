<?php

namespace Edel\AiChatbotPlus\Front;

use \WP_Error;
use \Exception;
use Edel\AiChatbotPlus\API\EdelAiChatbotOpenAIAPI;

class EdelAiChatbotFront {
    function front_enqueue() {
        $version  = (defined('EDEL_AI_CHATBOT_PLUS_DEVELOP') && true === EDEL_AI_CHATBOT_PLUS_DEVELOP) ? time() : EDEL_AI_CHATBOT_PLUS_VERSION;
        $strategy = array('in_footer' => true, 'strategy'  => 'defer');

        wp_register_style(EDEL_AI_CHATBOT_PLUS_SLUG . '-front',  EDEL_AI_CHATBOT_PLUS_URL . '/css/front.css', array(), $version);
        wp_register_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front', EDEL_AI_CHATBOT_PLUS_URL . '/js/front.js', array('jquery'), $version, $strategy);

        wp_enqueue_style(EDEL_AI_CHATBOT_PLUS_SLUG . '-front');
        wp_enqueue_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front');

        // ‚òÖ‚òÖ‚òÖ AjaxÈÄö‰ø°Áî®„ÅÆÊÉÖÂ†±„ÇíJavaScript„Å´Ê∏°„Åô ‚òÖ‚òÖ‚òÖ
        $ajax_nonce = wp_create_nonce(EDEL_AI_CHATBOT_PLUS_PREFIX . 'ajax_nonce'); // Nonce„ÇíÁîüÊàê
        $localized_data = array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce'    => $ajax_nonce,
            'action'   => EDEL_AI_CHATBOT_PLUS_PREFIX . 'send_message' // Ajax„Ç¢„ÇØ„Ç∑„Éß„É≥Âêç
        );
        wp_localize_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front', 'edel_chatbot_params', $localized_data);
    }

    /**
     * „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÅÆHTML„Çí„Éï„ÉÉ„Çø„Éº„Å´Âá∫Âäõ„Åô„Çã
     */
    public function output_floating_chatbot_ui() {
        $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
        $options = get_option($option_name, []);

        $is_enabled = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'enabled'] ?? '1'; // „Éá„Éï„Ç©„É´„ÉàÊúâÂäπ
        if ($is_enabled !== '1') {
            return;
        }

        $can_display = apply_filters('EDEL_AI_CHATBOT_PLUS_display_permission', true);
        if ($can_display !== true) {
            return;
        }

        $header_title     = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'header_title'] ?? 'AI„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà';
        $greeting_message = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'greeting_message'] ?? '„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü';
        $is_default_open = isset($options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'default_open']) && $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'default_open'] === '1';

        // ‚òÖ‚òÖ‚òÖ ÂàùÊúüÁä∂ÊÖã„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„Å®„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö ‚òÖ‚òÖ‚òÖ
        $window_classes = 'edel-chatbot-window';
        $button_style = '';
        if ($is_default_open) {
            $window_classes .= ' is-visible'; // ÊúÄÂàù„Åã„ÇâË°®Á§∫„ÇØ„É©„Çπ„Çí‰ªò‰∏é
            $button_style = 'style="display: none;"'; // ÊúÄÂàù„Åã„Çâ„Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
        }
        // ÁâπÂÆö„ÅÆÊù°‰ª∂‰∏ã„Åß„ÅÆ„ÅøË°®Á§∫„Åô„Çã„ÄÅ„Å™„Å©„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÇÇ„Åì„Åì„Å´ËøΩÂä†ÂèØËÉΩ
        // if ( is_admin() || is_embed() /* || ‰ªñ„ÅÆÊù°‰ª∂ */ ) { return; }
?>
        <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>widget-container">
            <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>open-button" class="edel-chatbot-open-button" <?php echo $button_style; ?>>
                <?php
                $default_icon_html = '<span class="edel-chatbot-icon">ü§ñ</span>';
                echo apply_filters('EDEL_AI_CHATBOT_PLUS_floating_icon', $default_icon_html);
                ?>
                <span class="edel-chatbot-button-text">Bot„Å´ËÅû„Åè</span>
            </button>

            <?php // --- „ÉÅ„É£„ÉÉ„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶Êú¨‰Ωì (ÊúÄÂàù„ÅØÈùûË°®Á§∫) ---
            ?>
            <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>window" class="<?php echo esc_attr($window_classes); ?>">
                <div class="edel-chatbot-header">
                    <span class="edel-chatbot-title"><?php echo esc_html($header_title); ?></span>
                    <div>
                        <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>maximize-button" class="edel-chatbot-header-button edel-chatbot-maximize-button" title="Êã°Â§ß/Á∏ÆÂ∞è">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z" />
                            </svg>
                        </button>
                        <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>close-button" class="edel-chatbot-header-button edel-chatbot-close-button" title="Èñâ„Åò„Çã">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>history" class="edel-chatbot-history">
                    <div class="edel-chatbot-message edel-chatbot-message-bot">
                        <p><?php echo nl2br(esc_html($greeting_message)); ?></p>
                    </div>
                </div>

                <?php // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ„Éï„Ç©„Éº„É†
                ?>
                <form id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>form" class="edel-chatbot-form">
                    <textarea id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1"></textarea>
                    <button type="submit" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>submit" class="edel-chatbot-submit-button">
                        <span class="edel-chatbot-send-icon">‚û§</span>
                    </button>
                    <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>loading" class="edel-chatbot-loading" style="display: none;"><span></span><span></span><span></span></div>
                </form>

            </div>

        </div>
    <?php
    }

    /**
     * „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÇíË°®Á§∫„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞
     *
     * @param array $atts „Ç∑„Éß„Éº„Éà„Ç≥„Éº„ÉâÂ±ûÊÄß (‰ªäÂõû„ÅØÊú™‰ΩøÁî®)
     * @return string „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÅÆHTML
     */
    public function render_chatbot_ui($atts = []) {
        // „Ç∑„Éß„Éº„Éà„Ç≥„Éº„ÉâÂ±ûÊÄß„ÅØ‰ªäÂõû„ÅØ‰Ωø„Çè„Å™„ÅÑ„Åå„ÄÅÂ∞ÜÊù•ÁöÑ„Å™Êã°Âºµ„ÅÆ„Åü„ÇÅ„Å´ÂºïÊï∞„ÅØÁî®ÊÑè„Åó„Å¶„Åä„Åè
        // $atts = shortcode_atts( array(
        //     'attribute' => 'default_value',
        // ), $atts, 'edel_chatbot' );

        ob_start(); // Âá∫Âäõ„Éê„ÉÉ„Éï„Ç°„É™„É≥„Ç∞ÈñãÂßã
    ?>
        <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>container" class="edel-chatbot-container">
            <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>history" class="edel-chatbot-history">
                <div class="edel-chatbot-message edel-chatbot-message-bot">
                    <p>„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</p>
                </div>
            </div>
            <form id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>form" class="edel-chatbot-form">
                <input type="text" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." required>
                <button type="submit" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>submit">ÈÄÅ‰ø°</button>
                <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>loading" class="edel-chatbot-loading" style="display: none;"><span></span><span></span><span></span></div>
            </form>
        </div>
<?php
        return ob_get_clean(); // „Éê„ÉÉ„Éï„Ç°„É™„É≥„Ç∞„Åó„ÅüÂÜÖÂÆπ„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶Ëøî„Åô
    }

    /**
     * „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Åã„Çâ„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°Ajax„Éè„É≥„Éâ„É© (‰øÆÊ≠£)
     */
    public function handle_send_message() {
        error_log('--- handle_send_message METHOD CALLED! ---');
        error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' handle_send_message started.'); // ‚òÖ„É≠„Ç∞ËøΩÂä† (ÈñãÂßã)

        global $wpdb; // DB„Ç¢„ÇØ„Çª„ÇπÁî®
        $vector_table_name = $wpdb->prefix . EDEL_AI_CHATBOT_PLUS_PREFIX . 'vectors'; // „Éô„ÇØ„Éà„É´„ÉÜ„Éº„Éñ„É´Âêç

        // NonceÊ§úË®º (Â§âÊõ¥„Å™„Åó)
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], EDEL_AI_CHATBOT_PLUS_PREFIX . 'ajax_nonce')) {
            wp_send_json_error(['message' => '‰∏çÊ≠£„Å™„É™„ÇØ„Ç®„Çπ„Éà„Åß„Åô„ÄÇ'], 403);
            return;
        }
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Éª„Çµ„Éã„Çø„Ç§„Ç∫ (Â§âÊõ¥„Å™„Åó)
        $user_message = isset($_POST['message']) ? sanitize_textarea_field(wp_unslash($_POST['message'])) : '';
        if (empty($user_message)) {
            wp_send_json_error(['message' => '„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„Åß„Åô„ÄÇ'], 400);
            return;
        }

        // ====[ AIÂøúÁ≠îÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ „Åì„Åì„Åã„Çâ ]====
        try {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' API Key found, proceeding...'); // ‚òÖ„É≠„Ç∞ËøΩÂä†

            // --- Ê∫ñÂÇôÔºöAPI„Ç≠„Éº„Å®„É¢„Éá„É´ÂèñÂæó ---
            $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
            $options = get_option($option_name, []);
            $api_key = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'api_key'] ?? '';
            $chat_model = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'model'] ?? 'gpt-3.5-turbo'; // Ë®≠ÂÆö„Åï„Çå„ÅüChat„É¢„Éá„É´

            if (empty($api_key)) {
                throw new Exception('OpenAI API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            }

            // --- API„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊ∫ñÂÇô ---
            require_once EDEL_AI_CHATBOT_PLUS_PATH . '/inc/class-openai-api.php'; // „ÇØ„É©„Çπ„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
            $openai_api = new EdelAiChatbotOpenAIAPI($api_key);

            // --- (a) Ë≥™Âïè„ÅÆ„Éô„ÇØ„Éà„É´Âåñ ---
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Got question embedding. Starting similarity search...');
            $question_vector = $openai_api->get_embedding($user_message);
            if (is_wp_error($question_vector)) {
                throw new Exception('Ë≥™Âïè„ÅÆ„Éô„ÇØ„Éà„É´Âåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' . $question_vector->get_error_message());
            }

            // --- (b) È°û‰ºº„Éô„ÇØ„Éà„É´Ê§úÁ¥¢ ---
            // DB„Åã„ÇâÂÖ®„Å¶„ÅÆ„Éô„ÇØ„Éà„É´„Éá„Éº„Çø„ÇíÂèñÂæó (‚òÖ„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊ≥®ÊÑè‚òÖ)
            $results = $wpdb->get_results("SELECT id, source_text, vector_data FROM {$vector_table_name}");

            // È°û‰ººÂ∫¶„ÇíÊ†ºÁ¥ç„Åô„ÇãÈÖçÂàó„ÇíÂàùÊúüÂåñ
            $similarities = [];

            if (empty($results)) {
                // Â≠¶Áøí„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' No learning data found in DB.');
                // $similarities „ÅØÁ©∫„ÅÆ„Åæ„Åæ
            } else {
                // È°û‰ººÂ∫¶Ë®àÁÆó„É´„Éº„Éó
                foreach ($results as $row) {
                    $db_vector = json_decode($row->vector_data, true); // JSONÊñáÂ≠óÂàó„ÇíPHPÈÖçÂàó„Å´
                    if (is_array($db_vector)) {
                        // „Ç≥„Çµ„Ç§„É≥È°û‰ººÂ∫¶„ÇíË®àÁÆó
                        $similarity = $this->calculate_cosine_similarity($question_vector, $db_vector);
                        if ($similarity !== false) {
                            // ÁµêÊûú„ÇíÈÖçÂàó„Å´ËøΩÂä†
                            $similarities[] = [
                                'id'         => $row->id,
                                'text'       => $row->source_text,
                                'similarity' => $similarity
                            ];
                        }
                    } else {
                        // JSON„Éá„Ç≥„Éº„ÉâÂ§±Êïó„Å™„Å©„ÅÆ„Ç®„É©„Éº„É≠„Ç∞
                        error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' DB Error: Failed to decode vector data for ID ' . $row->id);
                    }
                } // end foreach

                // È°û‰ººÂ∫¶„ÅßÈôçÈ†Ü„ÇΩ„Éº„Éà (ÁµêÊûú„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø)
                if (!empty($similarities)) {
                    usort($similarities, function ($a, $b) {
                        // $b['similarity'] „Åå $a['similarity'] „Çà„ÇäÂ§ß„Åç„Åë„Çå„Å∞ -1 „ÇíËøî„Åô (ÈôçÈ†Ü)
                        return $b['similarity'] <=> $a['similarity'];
                    });
                }
            } // end if !empty($results)

            // ‰∏ä‰ΩçN‰ª∂„ÇíÂèñÂæó (‰æã: 3‰ª∂)
            $top_n = 3;
            // $similarities „ÅåÁ©∫„Åß„ÇÇ array_slice „ÅØÁ©∫ÈÖçÂàó„ÇíËøî„Åô„ÅÆ„ÅßÂïèÈ°å„Å™„ÅÑ
            $context_chunks = array_slice($similarities, 0, $top_n); // ‚òÖ‚òÖ‚òÖ $context_chunks „ÅØ„Åì„Åì„ÅßÂÆöÁæ©„Åï„Çå„Çã ‚òÖ‚òÖ‚òÖ

            // ‚òÖ‚òÖ‚òÖ „É≠„Ç∞„ÅÆ‰ΩçÁΩÆ„Çí $context_chunks ÂÆöÁæ©Âæå„Å´ÁßªÂãï ‚òÖ‚òÖ‚òÖ
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Similarity search done. Found ' . count($context_chunks) . ' context chunks. Creating prompt...');

            // --- (c) „Éó„É≠„É≥„Éó„Éà‰ΩúÊàê ---
            $context_text = '';
            if (!empty($context_chunks)) { // $context_chunks „ÅØÂÆöÁæ©Ê∏à„Åø„Å™„ÅÆ„Åß Warning „ÅØÂá∫„Å™„ÅÑ„ÅØ„Åö
                $context_text = "‰ª•‰∏ã„ÅØÈñ¢ÈÄ£„Åô„ÇãÂèØËÉΩÊÄß„ÅÆ„ÅÇ„ÇãÊÉÖÂ†±„Åß„Åô„ÄÇ„Åì„Çå„ÇíÂèÇËÄÉ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n---\n";
                foreach ($context_chunks as $chunk) {
                    $context_text .= $chunk['text'] . "\n---\n";
                }
            } else {
                $context_text = "Èñ¢ÈÄ£ÊÉÖÂ†±„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' No relevant context chunks found.'); // Èñ¢ÈÄ£ÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇ„É≠„Ç∞
            }

            // OpenAI„Å´Ê∏°„Åô„É°„ÉÉ„Çª„Éº„Ç∏ÈÖçÂàó„Çí‰ΩúÊàê
            $messages = [
                ['role' => 'system', 'content' => "„ÅÇ„Å™„Åü„ÅØË¶™Âàá„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊèê‰æõ„Åï„Çå„ÅüÊÉÖÂ†±„ÇíÂÖÉ„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Å´Êó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊ≠£Áõ¥„Å´„ÄåÂàÜ„Åã„Çä„Åæ„Åõ„Çì„Äç„Å®Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"],
                ['role' => 'user', 'content' => $context_text . "\n\n„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè:\n" . $user_message]
            ];

            // --- (d) ÂøúÁ≠îÁîüÊàê ---
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Calling get_chat_completion...'); // Chat APIÂëº„Å≥Âá∫„ÅóÂâç„ÅÆ„É≠„Ç∞
            $bot_response = $openai_api->get_chat_completion($messages, $chat_model);

            if (is_wp_error($bot_response)) {
                throw new Exception('AI„Åã„Çâ„ÅÆÂøúÁ≠îÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' . $bot_response->get_error_message());
            }

            wp_send_json_success(['message' => $bot_response]);
        } catch (Exception $e) {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Exception caught in handle_send_message: ' . $e->getMessage());

            $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
            $options = get_option($option_name, []);
            $error_message_setting = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'error_message'] ?? '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';

            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Sending error response from settings: ' . $error_message_setting);
            wp_send_json_error(['message' => $error_message_setting]);
        }
        error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' handle_send_message finished.');
    } // end handle_send_message

    /**
     * ‰∫å„Å§„ÅÆ„Éô„ÇØ„Éà„É´Èñì„ÅÆ„Ç≥„Çµ„Ç§„É≥È°û‰ººÂ∫¶„ÇíË®àÁÆó„Åô„Çã
     * @param array $vecA „Éô„ÇØ„Éà„É´A (float„ÅÆÈÖçÂàó)
     * @param array $vecB „Éô„ÇØ„Éà„É´B (float„ÅÆÈÖçÂàó)
     * @return float|false È°û‰ººÂ∫¶ (-1„Åã„Çâ1„ÄÅÈÄöÂ∏∏„ÅØ0‰ª•‰∏ä) „Åæ„Åü„ÅØ„Ç®„É©„ÉºÊôÇ false
     */
    private function calculate_cosine_similarity(array $vecA, array $vecB) {
        $dotProduct = 0.0;
        $normA = 0.0;
        $normB = 0.0;
        $countA = count($vecA);
        $countB = count($vecB);

        // „Éô„ÇØ„Éà„É´„ÅÆÊ¨°ÂÖÉ„ÅåÈÅï„ÅÜ„Åã„ÄÅÁ©∫„ÅÆÂ†¥Âêà„ÅØË®àÁÆó‰∏çÂèØ
        if ($countA === 0 || $countA !== $countB) {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Cosine Similarity Error: Vector dimension mismatch or empty.');
            return false;
        }

        for ($i = 0; $i < $countA; $i++) {
            // ÈÖçÂàóË¶ÅÁ¥†„ÅåÊï∞ÂÄ§„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            if (!is_numeric($vecA[$i]) || !is_numeric($vecB[$i])) {
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Cosine Similarity Error: Non-numeric value found in vector at index ' . $i);
                return false;
            }
            $dotProduct += floatval($vecA[$i]) * floatval($vecB[$i]);
            $normA += floatval($vecA[$i]) * floatval($vecA[$i]);
            $normB += floatval($vecB[$i]) * floatval($vecB[$i]);
        }

        // „Çº„É≠Èô§ÁÆó„ÇíÈÅø„Åë„Çã
        if ($normA == 0 || $normB == 0) {
            return 0.0; // „Åæ„Åü„ÅØ false „ÇíËøî„Åô„Å™„Å©„ÄÅ‰ªïÊßò„Å´„Çà„Çã
        }

        return $dotProduct / (sqrt($normA) * sqrt($normB));
    }
}
