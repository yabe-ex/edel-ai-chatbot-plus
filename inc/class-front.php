<?php

namespace Edel\AiChatbotPlus\Front;

use Edel\AiChatbotPlus\API\EdelAiChatbotOpenAIAPI;
use Edel\AiChatbotPlus\API\EdelAiChatbotPlusPineconeClient;
use \WP_Error;
use \Exception;
use \Throwable;

class EdelAiChatbotFront {
    function front_enqueue() {
        $version  = (defined('EDEL_AI_CHATBOT_PLUS_DEVELOP') && true === EDEL_AI_CHATBOT_PLUS_DEVELOP) ? time() : EDEL_AI_CHATBOT_PLUS_VERSION;
        $strategy = array('in_footer' => true, 'strategy'  => 'defer');

        wp_register_style(EDEL_AI_CHATBOT_PLUS_SLUG . '-front',  EDEL_AI_CHATBOT_PLUS_URL . '/css/front.css', array(), $version);
        wp_register_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front', EDEL_AI_CHATBOT_PLUS_URL . '/js/front.js', array('jquery'), $version, $strategy);

        wp_enqueue_style(EDEL_AI_CHATBOT_PLUS_SLUG . '-front');
        wp_enqueue_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front');

        // ‚òÖ‚òÖ‚òÖ AjaxÈÄö‰ø°Áî®„ÅÆÊÉÖÂ†±„ÇíJavaScript„Å´Ê∏°„Åô ‚òÖ‚òÖ‚òÖ
        $ajax_nonce = wp_create_nonce(EDEL_AI_CHATBOT_PLUS_PREFIX . 'ajax_nonce'); // Nonce„ÇíÁîüÊàê
        $localized_data = array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce'    => $ajax_nonce,
            'action'   => EDEL_AI_CHATBOT_PLUS_PREFIX . 'send_message' // Ajax„Ç¢„ÇØ„Ç∑„Éß„É≥Âêç
        );
        wp_localize_script(EDEL_AI_CHATBOT_PLUS_SLUG . '-front', 'edel_chatbot_params', $localized_data);
    }

    /**
     * „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÅÆHTML„Çí„Éï„ÉÉ„Çø„Éº„Å´Âá∫Âäõ„Åô„Çã
     */
    public function output_floating_chatbot_ui() {
        $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
        $options = get_option($option_name, []);

        $is_enabled = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'enabled'] ?? '1'; // „Éá„Éï„Ç©„É´„ÉàÊúâÂäπ
        if ($is_enabled !== '1') {
            return;
        }

        $can_display = apply_filters('EDEL_AI_CHATBOT_PLUS_display_permission', true);
        if ($can_display !== true) {
            return;
        }

        $header_title     = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'header_title'] ?? 'AI„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà';
        $greeting_message = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'greeting_message'] ?? '„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü';
        $is_default_open = isset($options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'default_open']) && $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'default_open'] === '1';

        // ‚òÖ‚òÖ‚òÖ ÂàùÊúüÁä∂ÊÖã„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„Å®„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö ‚òÖ‚òÖ‚òÖ
        $window_classes = 'edel-chatbot-window';
        $button_style = '';
        if ($is_default_open) {
            $window_classes .= ' is-visible'; // ÊúÄÂàù„Åã„ÇâË°®Á§∫„ÇØ„É©„Çπ„Çí‰ªò‰∏é
            $button_style = 'style="display: none;"'; // ÊúÄÂàù„Åã„Çâ„Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
        }
        // ÁâπÂÆö„ÅÆÊù°‰ª∂‰∏ã„Åß„ÅÆ„ÅøË°®Á§∫„Åô„Çã„ÄÅ„Å™„Å©„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÇÇ„Åì„Åì„Å´ËøΩÂä†ÂèØËÉΩ
        // if ( is_admin() || is_embed() /* || ‰ªñ„ÅÆÊù°‰ª∂ */ ) { return; }
?>
        <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>widget-container">
            <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>open-button" class="edel-chatbot-open-button" <?php echo $button_style; ?>>
                <?php
                $default_icon_html = '<span class="edel-chatbot-icon">ü§ñ</span>';
                echo apply_filters('EDEL_AI_CHATBOT_PLUS_floating_icon', $default_icon_html);
                ?>
                <span class="edel-chatbot-button-text">Bot„Å´ËÅû„Åè</span>
            </button>

            <?php // --- „ÉÅ„É£„ÉÉ„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶Êú¨‰Ωì (ÊúÄÂàù„ÅØÈùûË°®Á§∫) ---
            ?>
            <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>window" class="<?php echo esc_attr($window_classes); ?>">
                <div class="edel-chatbot-header">
                    <span class="edel-chatbot-title"><?php echo esc_html($header_title); ?></span>
                    <div>
                        <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>maximize-button" class="edel-chatbot-header-button edel-chatbot-maximize-button" title="Êã°Â§ß/Á∏ÆÂ∞è">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z" />
                            </svg>
                        </button>
                        <button id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>close-button" class="edel-chatbot-header-button edel-chatbot-close-button" title="Èñâ„Åò„Çã">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>history" class="edel-chatbot-history">
                    <div class="edel-chatbot-message edel-chatbot-message-bot">
                        <p><?php echo nl2br(esc_html($greeting_message)); ?></p>
                    </div>
                </div>

                <?php // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ„Éï„Ç©„Éº„É†
                ?>
                <form id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>form" class="edel-chatbot-form">
                    <textarea id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1"></textarea>
                    <button type="submit" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>submit" class="edel-chatbot-submit-button">
                        <span class="edel-chatbot-send-icon">‚û§</span>
                    </button>
                    <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>loading" class="edel-chatbot-loading" style="display: none;"><span></span><span></span><span></span></div>
                </form>

            </div>

        </div>
    <?php
    }

    /**
     * „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÇíË°®Á§∫„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞
     *
     * @param array $atts „Ç∑„Éß„Éº„Éà„Ç≥„Éº„ÉâÂ±ûÊÄß (‰ªäÂõû„ÅØÊú™‰ΩøÁî®)
     * @return string „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàUI„ÅÆHTML
     */
    public function render_chatbot_ui($atts = []) {
        // „Ç∑„Éß„Éº„Éà„Ç≥„Éº„ÉâÂ±ûÊÄß„ÅØ‰ªäÂõû„ÅØ‰Ωø„Çè„Å™„ÅÑ„Åå„ÄÅÂ∞ÜÊù•ÁöÑ„Å™Êã°Âºµ„ÅÆ„Åü„ÇÅ„Å´ÂºïÊï∞„ÅØÁî®ÊÑè„Åó„Å¶„Åä„Åè
        // $atts = shortcode_atts( array(
        //     'attribute' => 'default_value',
        // ), $atts, 'edel_chatbot' );

        ob_start(); // Âá∫Âäõ„Éê„ÉÉ„Éï„Ç°„É™„É≥„Ç∞ÈñãÂßã
    ?>
        <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>container" class="edel-chatbot-container">
            <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>history" class="edel-chatbot-history">
                <div class="edel-chatbot-message edel-chatbot-message-bot">
                    <p>„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</p>
                </div>
            </div>
            <form id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>form" class="edel-chatbot-form">
                <input type="text" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." required>
                <button type="submit" id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>submit">ÈÄÅ‰ø°</button>
                <div id="<?php echo EDEL_AI_CHATBOT_PLUS_PREFIX; ?>loading" class="edel-chatbot-loading" style="display: none;"><span></span><span></span><span></span></div>
            </form>
        </div>
<?php
        return ob_get_clean(); // „Éê„ÉÉ„Éï„Ç°„É™„É≥„Ç∞„Åó„ÅüÂÜÖÂÆπ„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶Ëøî„Åô
    }

    /**
     * „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Åã„Çâ„ÅÆ„ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°Ajax„Éè„É≥„Éâ„É© (‰øÆÊ≠£)
     */
    public function handle_send_message() {
        error_log('--- handle_send_message METHOD CALLED! ---');
        error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' handle_send_message started.'); // ‚òÖ„É≠„Ç∞ËøΩÂä† (ÈñãÂßã)

        global $wpdb; // DB„Ç¢„ÇØ„Çª„ÇπÁî®
        $vector_table_name = $wpdb->prefix . EDEL_AI_CHATBOT_PLUS_PREFIX . 'vectors'; // „Éô„ÇØ„Éà„É´„ÉÜ„Éº„Éñ„É´Âêç

        // NonceÊ§úË®º (Â§âÊõ¥„Å™„Åó)
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], EDEL_AI_CHATBOT_PLUS_PREFIX . 'ajax_nonce')) {
            wp_send_json_error(['message' => '‰∏çÊ≠£„Å™„É™„ÇØ„Ç®„Çπ„Éà„Åß„Åô„ÄÇ'], 403);
            return;
        }
        // „É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó„Éª„Çµ„Éã„Çø„Ç§„Ç∫ (Â§âÊõ¥„Å™„Åó)
        $user_message = isset($_POST['message']) ? sanitize_textarea_field(wp_unslash($_POST['message'])) : '';
        if (empty($user_message)) {
            wp_send_json_error(['message' => '„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„Åß„Åô„ÄÇ'], 400);
            return;
        }

        // ====[ AIÂøúÁ≠îÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ „Åì„Åì„Åã„Çâ ]====
        try {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' API Key found, proceeding...'); // ‚òÖ„É≠„Ç∞ËøΩÂä†

            // --- Ê∫ñÂÇôÔºöAPI„Ç≠„Éº„Å®„É¢„Éá„É´ÂèñÂæó ---
            $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
            $options = get_option($option_name, []);
            $api_key = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'api_key'] ?? '';
            $chat_model = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'model'] ?? 'gpt-3.5-turbo'; // Ë®≠ÂÆö„Åï„Çå„ÅüChat„É¢„Éá„É´

            $ai_service = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'ai_service'] ?? 'openai';

            $openai_api_key        = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'api_key'] ?? '';
            $openai_chat_model     = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'model'] ?? 'gpt-3.5-turbo';
            $google_api_key        = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'google_api_key'] ?? '';
            $gemini_chat_model     = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'gemini_model'] ?? 'gemini-1.5-flash';

            $pinecone_api_key     = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'pinecone_api_key'] ?? '';
            $pinecone_environment = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'pinecone_environment'] ?? '';
            $pinecone_index_name  = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'pinecone_index_name'] ?? '';
            $pinecone_host        = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'pinecone_host'] ?? '';

            if ($ai_service === 'openai' && empty($openai_api_key)) {
                throw new \Exception('OpenAI API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            }
            if ($ai_service === 'gemini' && empty($google_api_key)) {
                throw new \Exception('Google API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            }

            if (empty($api_key) || empty($pinecone_api_key) || empty($pinecone_environment) || empty($pinecone_index_name) || empty($pinecone_host)) {
                throw new Exception('API„Ç≠„Éº„Åæ„Åü„ÅØPineconeË®≠ÂÆö„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁÆ°ÁêÜÁîªÈù¢„ÅßË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' API Key and Pinecone settings found...');

            // --- API„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊ∫ñÂÇô ---
            require_once EDEL_AI_CHATBOT_PLUS_PATH . '/inc/class-openai-api.php'; // „ÇØ„É©„Çπ„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
            $openai_api = new EdelAiChatbotOpenAIAPI($api_key);

            require_once EDEL_AI_CHATBOT_PLUS_PATH . '/inc/class-pinecone-client.php';
            $pinecone_client = new \Edel\AiChatbotPlus\API\EdelAiChatbotPlusPineconeClient(
                $pinecone_api_key,
                $pinecone_environment,
                $pinecone_index_name,
                $pinecone_host
            );

            // --- (a) Ë≥™Âïè„ÅÆ„Éô„ÇØ„Éà„É´Âåñ ---
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Got question embedding. Starting similarity search...');
            $question_vector = $openai_api->get_embedding($user_message);
            if (is_wp_error($question_vector)) {
                throw new Exception('Ë≥™Âïè„ÅÆ„Éô„ÇØ„Éà„É´Âåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' . $question_vector->get_error_message());
            }
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Got question embedding. Querying Pinecone...');

            $top_n = 3; // ÂèñÂæó„Åô„ÇãÈ°û‰ºº„ÉÅ„É£„É≥„ÇØÊï∞
            $query_result = $pinecone_client->query(
                $question_vector,
                $top_n,
                null, // filter (ÂøÖË¶Å„Å™„ÇâËøΩÂä†)
                null, // namespace (ÂøÖË¶Å„Å™„ÇâËøΩÂä†)
                true, // includeMetadata („É°„Çø„Éá„Éº„Çø„ÇíÂèñÂæó)
                false // includeValues („Éô„ÇØ„Éà„É´ÂÄ§„ÅØ‰∏çË¶Å)
            );

            if (is_wp_error($query_result)) {
                throw new \Exception('Pinecone„Åß„ÅÆÈ°û‰ººÊÉÖÂ†±Ê§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' . $query_result->get_error_message());
            }

            $context_chunks = []; // „Åæ„ÅöÁ©∫„ÅßÂàùÊúüÂåñ
            if (isset($query_result['matches']) && is_array($query_result['matches'])) {
                // Pinecone„ÅåËøî„Åó„Åü matches ÈÖçÂàó„Çí„Åù„ÅÆ„Åæ„Åæ‰Ωø„ÅÜ (topK„Åß‰ª∂Êï∞ÊåáÂÆöÊ∏à„Åø„ÅÆ„Åü„ÇÅ)
                $context_chunks = $query_result['matches'];
            } else {
                // matches „Åå„Å™„ÅÑ„ÅãÈÖçÂàó„Åß„Å™„ÅÑÂ†¥Âêà („Ç®„É©„ÉºÂøúÁ≠î„Å™„Å©)
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Pinecone query did not return expected matches array. Response: ' . print_r($query_result, true));
            }

            // ‚òÖ‚òÖ‚òÖ „É≠„Ç∞„ÅÆ‰ΩçÁΩÆ„Çí $context_chunks ÂÆöÁæ©Âæå„Å´ÁßªÂãï ‚òÖ‚òÖ‚òÖ
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Pinecone query done. Found ' . count($context_chunks) . ' matches. Creating prompt...');

            // --- (c) „Éó„É≠„É≥„Éó„Éà‰ΩúÊàê ---
            $context_text = '';
            $context_chunks_count = 0;
            // Pinecone„ÅÆÂøúÁ≠îÂΩ¢Âºè ('matches' ÈÖçÂàó) „Åã„Çâ„É°„Çø„Éá„Éº„Çø„ÇíÊäΩÂá∫
            if (isset($query_result['matches']) && !empty($query_result['matches'])) {
                $context_text = "‰ª•‰∏ã„ÅØÈñ¢ÈÄ£„Åô„ÇãÂèØËÉΩÊÄß„ÅÆ„ÅÇ„ÇãÊÉÖÂ†±„Åß„Åô„ÄÇ„Åì„Çå„ÇíÂèÇËÄÉ„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n---\n";
                foreach ($query_result['matches'] as $match) {
                    // score „ÇÑ metadata „ÅØÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç„Åô„ÇãÊñπ„ÅåÂÆâÂÖ®
                    $text_preview = $match['metadata']['text_preview'] ?? ''; // „É°„Çø„Éá„Éº„Çø„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„Éó„É¨„Éì„É•„ÉºÂèñÂæó
                    $similarity_score = $match['score'] ?? 0; // È°û‰ººÂ∫¶„Çπ„Ç≥„Ç¢„ÇÇÂèñÂæóÂèØËÉΩ

                    // („Ç™„Éó„Ç∑„Éß„É≥) È°û‰ººÂ∫¶„Çπ„Ç≥„Ç¢„Åå‰Ωé„ÅÑ„ÇÇ„ÅÆ„ÅØÈô§Â§ñ„Åô„Çã
                    // if ($similarity_score < 0.7) continue;

                    if (!empty($text_preview)) {
                        $context_text .= $text_preview . "\n---\n"; // „Éó„É¨„Éì„É•„Éº„Çí„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Å´ËøΩÂä†
                        $context_chunks_count++;
                    }
                    // (Ê≥®ÊÑè) text_preview „Å†„Åë„Å†„Å®ÊÉÖÂ†±„ÅåË∂≥„Çä„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ
                    // source_post_id „Çí‰Ωø„Å£„Å¶DB„Åã„ÇâÂÆåÂÖ®„Å™ source_text „ÇíÂºï„ÅèÂá¶ÁêÜ„ÅåÂøÖË¶Å„Å´„Å™„ÇãÂ†¥Âêà„ÇÇ
                }
            }

            if ($context_chunks_count === 0) {
                $context_text = "Èñ¢ÈÄ£ÊÉÖÂ†±„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' No relevant context chunks found from Pinecone.');
            } else {
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Found ' . $context_chunks_count . ' context chunks from Pinecone.');
            }

            // OpenAI„Å´Ê∏°„Åô„É°„ÉÉ„Çª„Éº„Ç∏ÈÖçÂàó„Çí‰ΩúÊàê
            $messages = [
                ['role' => 'system', 'content' => "„ÅÇ„Å™„Åü„ÅØË¶™Âàá„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊèê‰æõ„Åï„Çå„ÅüÊÉÖÂ†±„ÇíÂÖÉ„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Å´Êó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊ≠£Áõ¥„Å´„ÄåÂàÜ„Åã„Çä„Åæ„Åõ„Çì„Äç„Å®Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"],
                ['role' => 'user', 'content' => $context_text . "\n\n„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè:\n" . $user_message]
            ];

            // --- (d) ÂøúÁ≠îÁîüÊàê ---
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Calling get_chat_completion...'); // Chat APIÂëº„Å≥Âá∫„ÅóÂâç„ÅÆ„É≠„Ç∞
            $bot_response =  '';

            if ($ai_service === 'gemini') {
                // === Google Gemini „ÅÆÂ†¥Âêà ===
                // API„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊ∫ñÂÇô (Gemini ChatÁî®)
                require_once EDEL_AI_CHATBOT_PLUS_PATH . '/inc/class-google-gemini-api.php';
                $gemini_api = new \Edel\AiChatbotPlus\API\EdelAiChatbotPlusGeminiAPI($google_api_key);

                // „Éó„É≠„É≥„Éó„Éà„Çí Gemini API „ÅÆ contents ÂΩ¢Âºè„Å´Â§âÊèõ
                $prompt_text = $context_text . "\n\n„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè:\n" . $user_message;
                $gemini_contents = [
                    [
                        'role' => 'user', // user„É≠„Éº„É´„Å´„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Å®Ë≥™Âïè„ÇíÂÖ•„Çå„Çã
                        'parts' => [['text' => $prompt_text]]
                    ]
                    // ÂøÖË¶Å„Å™„Çâ„Ç∑„Çπ„ÉÜ„É†ÊåáÁ§∫„ÇíÂà•„ÅÆÂΩ¢„ÅßËøΩÂä†Ôºà„É¢„Éá„É´„Å´„Çà„ÇãÔºâ
                ];
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Calling Gemini API (' . $gemini_chat_model . ')');
                $bot_response_or_error = $gemini_api->generateContent($gemini_contents, $gemini_chat_model);
            } else {
                // === OpenAI „ÅÆÂ†¥Âêà („Éá„Éï„Ç©„É´„Éà) ===
                // API„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊ∫ñÂÇô (OpenAI ChatÁî® - Embedding„Å®Âêå„Åò„Ç≠„Éº„Çí‰Ωø„ÅÜ)
                $openai_chat_client = $openai_embedding_client; // Âêå„Åò„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅßOK

                // „Éó„É≠„É≥„Éó„Éà„Çí OpenAI API „ÅÆ messages ÂΩ¢Âºè„Å´Â§âÊèõ
                $openai_messages = [
                    ['role' => 'system', 'content' => "„ÅÇ„Å™„Åü„ÅØË¶™Âàá„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÊèê‰æõ„Åï„Çå„ÅüÊÉÖÂ†±„ÇíÂÖÉ„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Å´Êó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊ≠£Áõ¥„Å´„ÄåÂàÜ„Åã„Çä„Åæ„Åõ„Çì„Äç„Å®Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"],
                    ['role' => 'user', 'content' => $context_text . "\n\n„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè:\n" . $user_message]
                ];
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Calling OpenAI Chat API (' . $openai_chat_model . ')');
                $bot_response_or_error = $openai_chat_client->get_chat_completion($openai_messages, $openai_chat_model);
            }
            // APIÂøúÁ≠î„ÉÅ„Çß„ÉÉ„ÇØ
            if (is_wp_error($bot_response_or_error)) {
                throw new \Exception('AI„Åã„Çâ„ÅÆÂøúÁ≠îÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' . $bot_response_or_error->get_error_message());
            }
            $bot_response = $bot_response_or_error; // Ê≠£Â∏∏„Å™ÂøúÁ≠î„ÉÜ„Ç≠„Çπ„Éà
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' AI response received.');

            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Sending success JSON.');
            wp_send_json_success(['message' => $bot_response]);
        } catch (Exception $e) {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Exception caught in handle_send_message: ' . $e->getMessage());

            $option_name = EDEL_AI_CHATBOT_PLUS_PREFIX . 'settings';
            $options = get_option($option_name, []);
            $error_message_setting = $options[EDEL_AI_CHATBOT_PLUS_PREFIX . 'error_message'] ?? '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';

            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Sending error response from settings: ' . $error_message_setting);
            wp_send_json_error(['message' => $error_message_setting]);
        }
        error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' handle_send_message finished.');
    } // end handle_send_message

    /**
     * ‰∫å„Å§„ÅÆ„Éô„ÇØ„Éà„É´Èñì„ÅÆ„Ç≥„Çµ„Ç§„É≥È°û‰ººÂ∫¶„ÇíË®àÁÆó„Åô„Çã
     * @param array $vecA „Éô„ÇØ„Éà„É´A (float„ÅÆÈÖçÂàó)
     * @param array $vecB „Éô„ÇØ„Éà„É´B (float„ÅÆÈÖçÂàó)
     * @return float|false È°û‰ººÂ∫¶ (-1„Åã„Çâ1„ÄÅÈÄöÂ∏∏„ÅØ0‰ª•‰∏ä) „Åæ„Åü„ÅØ„Ç®„É©„ÉºÊôÇ false
     */
    private function calculate_cosine_similarity(array $vecA, array $vecB) {
        $dotProduct = 0.0;
        $normA = 0.0;
        $normB = 0.0;
        $countA = count($vecA);
        $countB = count($vecB);

        // „Éô„ÇØ„Éà„É´„ÅÆÊ¨°ÂÖÉ„ÅåÈÅï„ÅÜ„Åã„ÄÅÁ©∫„ÅÆÂ†¥Âêà„ÅØË®àÁÆó‰∏çÂèØ
        if ($countA === 0 || $countA !== $countB) {
            error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Cosine Similarity Error: Vector dimension mismatch or empty.');
            return false;
        }

        for ($i = 0; $i < $countA; $i++) {
            // ÈÖçÂàóË¶ÅÁ¥†„ÅåÊï∞ÂÄ§„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            if (!is_numeric($vecA[$i]) || !is_numeric($vecB[$i])) {
                error_log(EDEL_AI_CHATBOT_PLUS_PREFIX . ' Cosine Similarity Error: Non-numeric value found in vector at index ' . $i);
                return false;
            }
            $dotProduct += floatval($vecA[$i]) * floatval($vecB[$i]);
            $normA += floatval($vecA[$i]) * floatval($vecA[$i]);
            $normB += floatval($vecB[$i]) * floatval($vecB[$i]);
        }

        // „Çº„É≠Èô§ÁÆó„ÇíÈÅø„Åë„Çã
        if ($normA == 0 || $normB == 0) {
            return 0.0; // „Åæ„Åü„ÅØ false „ÇíËøî„Åô„Å™„Å©„ÄÅ‰ªïÊßò„Å´„Çà„Çã
        }

        return $dotProduct / (sqrt($normA) * sqrt($normB));
    }
}
